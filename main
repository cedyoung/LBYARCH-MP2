#include <stdio.h>
#include <stdlib.h>
#include <windows.h>
#include <math.h>

extern void daxpy_asm(long long n, double A, double* X, double* Y, double* Z);

void daxpy_c(long long n, double A, double* X, double* Y, double* Z) {
    long long i;
    for (i = 0; i < n; i++) {
        Z[i] = A * X[i] + Y[i];
    }
}

int main() {
    // 2^20, 2^24, 2^29 (Adjusted max size for safety)
    long long sizes[] = { 1 << 20, 1 << 24, 1 << 29 };
    int num_sizes = 3;
    double A = 2.0;
    
    printf("MP2 Benchmark: C vs x86-64 Assembly\n");
    printf("-----------------------------------\n");

    for (int s = 0; s < num_sizes; s++) {
        long long n = sizes[s];
        printf("\n[n = %lld]\n", n);

        double* X = (double*)malloc(n * sizeof(double));
        double* Y = (double*)malloc(n * sizeof(double));
        double* Z_asm = (double*)malloc(n * sizeof(double));
        double* Z_c = (double*)malloc(n * sizeof(double));

        if (!X || !Y || !Z_asm || !Z_c) {
            printf("Memory allocation failed.\n");
            if(X) free(X); if(Y) free(Y); if(Z_asm) free(Z_asm); if(Z_c) free(Z_c);
            break;
        }

        for (long long i = 0; i < n; i++) {
            X[i] = (double)rand() / RAND_MAX;
            Y[i] = (double)rand() / RAND_MAX;
        }

        daxpy_c(n, A, X, Y, Z_c);
        daxpy_asm(n, A, X, Y, Z_asm);

        int correct = 1;
        for (long long i = 0; i < 10; i++) {
            if (fabs(Z_c[i] - Z_asm[i]) > 1e-9) correct = 0;
        }
        
        printf("Sanity Check: %s\n", correct ? "PASSED" : "FAILED");
        if (!correct) { 
            printf("Sample mismatch: C=%.2f ASM=%.2f\n", Z_c[0], Z_asm[0]); 
        }

        LARGE_INTEGER frequency, start, end;
        QueryPerformanceFrequency(&frequency);
        double totalTime = 0;

        for (int k = 0; k < 30; k++) {
            QueryPerformanceCounter(&start);
            daxpy_asm(n, A, X, Y, Z_asm);
            QueryPerformanceCounter(&end);
            totalTime += (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
        }
        printf("Avg Execution Time (ASM): %.6f seconds\n", totalTime / 30.0);

        free(X); free(Y); free(Z_asm); free(Z_c);
    }
    return 0;
}